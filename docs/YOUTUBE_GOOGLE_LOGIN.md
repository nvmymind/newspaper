# 유튜브 구독 영상 – Google 로그인 설정

`/youtube` 페이지에서 Google 로그인 후 구독 채널의 최신 영상을 썸네일로 보려면 아래 설정이 필요합니다. **사설 기능과 무관**하며, 설정하지 않으면 유튜브 페이지에서만 로그인 버튼을 눌렀을 때 안내 메시지가 뜹니다.

---

## 1. Google Cloud Console 들어가기

1. 브라우저에서 **https://console.cloud.google.com/** 접속
2. **Google 계정으로 로그인** (이메일·비밀번호 입력)
3. 처음이면 "약관 동의" 등이 나올 수 있음 → **동의** 후 진행

---

## 2. 프로젝트 만들기(또는 선택)

1. 페이지 **맨 위**에 있는 **프로젝트 선택** 드롭다운 클릭 (제목 옆 "Google Cloud" 같은 곳)
2. **새 프로젝트** 클릭
   - 프로젝트 이름: 예) `newspaper-youtube` (아무 이름이나 가능)
   - **만들기** 클릭
3. 만들어진 프로젝트가 자동으로 선택됨. 위쪽에 프로젝트 이름이 보이면 OK

---

## 3. YouTube Data API v3 켜기

1. 왼쪽 **≡ (햄버거 메뉴)** 클릭
2. **API 및 서비스** → **라이브러리** 클릭
3. 검색창에 **YouTube Data API v3** 입력
4. **YouTube Data API v3** 카드 클릭
5. **사용** 버튼 클릭 → "API를 사용 설정했습니다" 나오면 완료

---

## 4. OAuth 동의 화면 설정 (한 번만)

1. 왼쪽 **≡** → **API 및 서비스** → **OAuth 동의 화면** 클릭
2. **외부** 선택 → **만들기** 클릭
3. **앱 정보** 입력:
   - 앱 이름: 예) `신문 사설 유튜브`
   - 사용자 지원 이메일: 본인 Gmail 선택
   - 개발자 연락처 이메일: 본인 Gmail 입력
4. **저장 후 계속** 클릭
5. **범위** 화면에서 **저장 후 계속** (추가 범위 안 넣어도 됨)
6. **테스트 사용자**에서 **+ 추가** 클릭 → 로그인에 사용할 **Gmail 주소** 입력(본인 계정 포함) → **저장 후 계속** → **대시보드로 돌아가기**  
   - ⚠️ 여기서 추가하지 않으면 나중에 "액세스 차단됨 / 인증 절차를 완료하지 않았습니다" 오류가 납니다.

---

## 5. OAuth 클라이언트 ID 만들기 (여기서 주소·비밀번호 받음)

1. 왼쪽 **≡** → **API 및 서비스** → **사용자 인증 정보** 클릭
2. 위쪽 **+ 사용자 인증 정보 만들기** 클릭
3. **OAuth 클라이언트 ID** 선택
4. **애플리케이션 유형**: **웹 애플리케이션** 선택
5. **이름**: 예) `newspaper-youtube` (아무 이름이나 가능)
6. **승인된 리디렉션 URI**에서 **+ URI 추가** 클릭 후, 아래를 **한 글자도 틀리지 않게** 입력:
   ```text
   http://127.0.0.1:8000/auth/google/callback
   ```
   - `https` 아님, `http` 로 입력
   - 끝에 `/` 없음
   - 포트 `8000` 그대로
7. **만들기** 클릭
8. **OAuth 클라이언트가 생성되었습니다** 창이 뜸:
   - **클라이언트 ID** (긴 글자) → 복사해서 메모장 등에 붙여넣기
   - **클라이언트 보안 비밀** → **복사** 클릭해서 메모장에 붙여넣기
9. **확인** 클릭해서 창 닫기

이제 **클라이언트 ID**와 **클라이언트 보안 비밀** 두 개를 가지고 있으면 됨.

## 6. 프로젝트 .env 설정

프로젝트 폴더 **`c:\newspaper`** 안에 **`.env`** 파일을 만듭니다. (이미 있으면 열기)

아래 세 줄을 넣되, **클라이언트 ID**와 **클라이언트 보안 비밀**은 5번에서 복사한 값으로 바꿉니다.

```env
GOOGLE_CLIENT_ID=여기에_5번에서_복사한_클라이언트_ID
GOOGLE_CLIENT_SECRET=여기에_5번에서_복사한_클라이언트_보안_비밀
SECRET_KEY=아무거나32자이상긴문자열
```

- `SECRET_KEY`: 아무 문장이나 32자 이상 (예: `my-secret-key-12345-long-enough`)

## 7. 서버 재시작

`.env`를 저장한 뒤 **uvicorn 서버를 한 번 종료했다가 다시 실행**해야 합니다.

```powershell
# Ctrl+C로 종료 후
uvicorn app.main:app --reload --host 127.0.0.1 --port 8000
```

시작 시 터미널에 `[유튜브] Google 로그인: 설정됨` 이 나오면 설정이 적용된 것입니다.

## 8. 동작 확인

1. 브라우저에서 **http://127.0.0.1:8000** 접속  
2. **유튜브 구독영상** 버튼 클릭 → `/youtube` 페이지(새 탭)  
3. **Google로 로그인** 클릭 → Google 로그인 화면으로 이동  
4. 계정 선택·권한 허용 후 `/youtube`로 돌아오면 구독 채널·최신 영상 썸네일이 **최신순**으로 표시  
5. **정렬** 드롭다운으로 최신순/오래된순 변경 가능  
6. 썸네일 클릭 시 해당 유튜브 영상 페이지로 이동

## 로그인 실패 시

- **"액세스 차단됨" / "인증 절차를 완료하지 않았습니다" (403 access_denied)**  
  → OAuth 앱이 **테스트 모드**라서, **테스트 사용자로 등록된 계정만** 로그인할 수 있습니다.  
  **Google Cloud Console** → **API 및 서비스** → **OAuth 동의 화면** → **테스트 사용자**에서 **+ 추가**로 로그인할 Gmail 주소를 넣고 저장하세요.
- **리디렉션 URI가 일치하지 않음**  
  Google 콘솔의 "승인된 리디렉션 URI"와 실제 사용 주소가 **완전히 같아야** 합니다.  
  - `http` vs `https`, 포트 번호, 끝의 `/` 유무까지 동일해야 함.
- **토큰 교환 실패**  
  서버 터미널에 `[유튜브] Google 토큰 교환 실패 ...` 로그가 나오면, 그 내용을 확인해 리디렉션 URI·클라이언트 비밀을 다시 점검하면 됩니다.

---

## 누구나 로그인하게 하려면 (앱 게시)

지금은 **테스트 모드**라서 **테스트 사용자로 등록한 계정만** 로그인할 수 있습니다. **다른 사람들도** 자기 Google 계정으로 로그인하려면, 앱을 **게시(프로덕션)** 로 전환해야 합니다.

1. **https://console.cloud.google.com/** → 프로젝트 선택  
2. **API 및 서비스** → **OAuth 동의 화면**  
3. 화면 상단에 **「앱 게시」** 또는 **「PUBLISH APP」** 버튼이 보이면 클릭  
4. **「앱 게시」** 확인 시 **「확인」** 선택  

이렇게 하면 **테스트 사용자 목록에 없어도** 누구나 Google 로그인을 시도할 수 있습니다.

- **처음 게시 직후**: 로그인 시 **「Google에서 확인하지 않은 앱」** 경고가 나올 수 있습니다.  
  → 사용자가 **고급** → **(사이트 이름)(으)로 이동** 을 누르면 그대로 로그인됩니다.  
- **Google 앱 검증**: 나중에 사용자 수가 많아지거나, Google 정책에 따라 **앱 검증**을 요구받을 수 있습니다. 그때는 콘솔 안내에 따라 개인정보처리방침·앱 설명 등을 제출하면 됩니다. 당장은 게시만 해도 다른 사람 로그인은 가능합니다.

---

## "확인되지 않은 앱" 경고 없애기 (Google 검증)

로그인 시 **「Google에서 확인하지 않은 앱」** 경고가 뜨고, **고급** → **soneson.kr(으)로 이동(안전하지 않음)** 을 눌러야 하는 상황을 줄이려면, Google에 **앱 검증**을 요청해야 합니다. 그 전에 **개인정보처리방침·서비스 약관 URL**을 OAuth 동의 화면에 넣어 두어야 합니다.

### 1단계: 사이트에 개인정보처리방침·약관 페이지가 있는지 확인

이 프로젝트에는 아래 주소로 접속 가능한 페이지가 포함되어 있습니다. 배포 후 주소를 그대로 사용하면 됩니다.

- **개인정보처리방침**: `https://www.soneson.kr/privacy`
- **서비스 약관**: `https://www.soneson.kr/terms`

(로컬에서는 `http://127.0.0.1:8000/privacy`, `http://127.0.0.1:8000/terms` 로 확인할 수 있습니다.)

### 2단계: Google 콘솔에 URL 등록

1. **https://console.cloud.google.com/** → **프로젝트 선택**(상단 프로젝트 이름 클릭)  
2. 왼쪽 **≡** 메뉴 → **API 및 서비스** → **OAuth 동의 화면**  
3. **앱 수정**이 안 보일 때:
   - **앱 정보** 카드/섹션이 보이면 → **앱 정보** 제목 옆 **연필(편집) 아이콘** 또는 **앱 정보** 영역을 클릭해 보기  
   - 또는 **브랜딩** 메뉴가 있으면 **브랜딩** 클릭  
   - 또는 아래 **직접 링크**로 이동한 뒤, 같은 프로젝트가 선택돼 있는지 확인:
     - **OAuth 동의 화면 편집**:  
       `https://console.cloud.google.com/apis/credentials/consent?project=여기에_프로젝트_ID`  
       (프로젝트 ID는 상단 프로젝트 선택 창에서 해당 프로젝트 클릭 시 URL에 `project=...` 로 나옴)  
4. **앱 정보** 단계(또는 첫 설정 화면)에서 다음을 입력:
   - **앱 개인정보처리방침 링크**: `https://www.soneson.kr/privacy`
   - **앱 서비스 약관 링크**: `https://www.soneson.kr/terms`
   - (앱 이름·지원 이메일 등도 채워 두기)  
5. **저장 후 계속** → 필요한 단계를 모두 저장

이렇게 하면 동의 화면에 위 링크가 노출되고, 검증 요청 시 필수 항목을 만족하게 됩니다.

### 3단계: 검증 제출 (선택, 경고 제거용)

경고를 **완전히** 없애려면 Google 앱 검증을 받아야 합니다.

**앱 검증 요청이 안 보일 때**

- **앱을 먼저 게시(프로덕션)해야** 「검증 준비」·「검증 제출」 버튼이 나타납니다. 아직 테스트 모드면 **앱 게시**를 먼저 하세요.
- **새 콘솔(Google 인증 플랫폼)** 에서는 **브랜딩 확인**(Brand verification)이 앱 검증과 같은 맥락입니다. 왼쪽 메뉴 **브랜딩**에서 앱 정보·개인정보처리방침·서비스 약관을 채운 뒤, **브랜딩 확인** 요청을 하면 됩니다.
- 기존 **OAuth 동의 화면** 쪽에만 버튼이 있을 수 있으므로, 아래 **직접 링크**도 함께 확인하세요.

**직접 링크 (프로젝트 선택 후 사용)**

1. **OAuth 동의 화면(기존 화면)**  
   `https://console.cloud.google.com/apis/credentials/consent`  
   → 상단에서 **Newspaper-Youtube** 등 사용 중인 프로젝트가 선택돼 있는지 확인  
   → 페이지 **맨 아래**까지 내려가면 **「검증 준비」**(Prepare for verification) / **「검증 제출」**(Submit for verification) 버튼이 있을 수 있음  

2. **검증 대시보드**  
   `https://console.cloud.google.com/auth/verification`  
   → 여기서 검증 상태 확인·제출 시작할 수 있는 경우가 있음  

**제출 순서**

1. **앱 게시** (테스트 → 프로덕션)  
2. **검증 준비** 클릭 → 안내에 따라 정보 확인 후 **저장 후 계속**  
3. **검증 제출** 클릭 → 데모 영상·범위 설명 등 제출  
4. 검토에 **며칠~몇 주** 걸릴 수 있음. 승인되면 **「확인되지 않은 앱」** 경고가 사라집니다.

검증을 제출하지 않아도, 1·2단계까지 해 두면 동의 화면에 개인정보처리방침·약관 링크가 보여서 사용자가 더 안심하고 **고급** → **이동**을 선택할 수 있습니다.

### 브랜딩 인증 시 "이전 인증 시도에서 발견된 문제" 해결

브랜딩 확인을 요청했을 때 **브랜딩 인증 문제** 목록이 뜨면, 아래를 순서대로 확인하세요.

| 문제 메시지 | 해결 방법 |
|------------|-----------|
| **홈페이지 URL의 웹사이트가 나에게 등록되어 있지 않습니다** | [Google Search Console](https://search.google.com/search-console)에서 **소유권 확인**을 해야 합니다. Railway 배포 시 절차는 아래 **「Search Console 소유권 확인 (Railway 배포 시)」** 를 참고하세요. |
| **홈페이지에 개인정보처리방침 링크가 없습니다** | 메인 페이지(홈)에 **개인정보처리방침** 링크가 있어야 합니다. 이 프로젝트 메인 페이지 하단에 「개인정보처리방침」「서비스 약관」 링크가 포함되어 있으므로, 배포 후 홈에서 해당 링크가 보이는지 확인하세요. |
| **개인정보처리방침 URL의 형식이 잘못되었습니다** | `/privacy` 페이지가 **HTML**로 정상 열리고, 리디렉션 없이 바로 내용이 보여야 합니다. 브라우저에서 `https://www.soneson.kr/privacy` 를 직접 열어 확인한 뒤, 문제 해결 후 **브랜딩 재인증**을 요청하세요. |
| **홈페이지에 앱의 목적에 관한 설명이 없습니다** | 메인 페이지에 "본 서비스는 신문 사설 수집·조회와 Google 로그인 기반 유튜브 구독 영상 보기를 제공합니다" 같은 **앱 목적 설명**이 포함되어 있어야 합니다. 포함된 상태로 배포했는지 확인하세요. |
| **OAuth 앱 이름('newspaper')이 홈페이지의 앱 이름과 일치하지 않습니다** | 동의 화면에 넣은 **앱 이름**(예: newspaper)이 홈페이지에 **그대로 노출**되어야 합니다. 이 프로젝트 메인 페이지 하단에 "Newspaper (신문 사설 모음)"이 표시되도록 되어 있습니다. OAuth 브랜딩에서 앱 이름을 **Newspaper** 또는 **신문 사설 모음**으로 통일해 두세요. |

위 항목을 모두 수정한 뒤 **문제 해결함** → **계속**으로 브랜딩 재인증을 요청하면 됩니다.

### Search Console 소유권 확인 (Railway 배포 시)

사이트가 **Railway**에 배포되어 있을 때, Google에 "이 도메인은 내가 소유한 사이트다"라고 증명하는 방법입니다. 아래 **방법 1(HTML 태그)** 를 추천합니다.

1. **https://search.google.com/search-console** 접속 후 Google 계정으로 로그인  
2. **속성 추가** 클릭 → **URL 접두어** 선택 후 `https://www.soneson.kr` 입력 (본인 도메인에 맞게 수정)  
3. 소유권 확인 방법 중 하나를 선택해 진행:

---

**방법 1: HTML 태그 (추천, Railway 환경 변수 사용)**

1. Search Console에서 **HTML 태그** 방식 선택  
2. 화면에 나오는 `<meta name="google-site-verification" content="여기긴문자열" />` 에서 **content 안의 값만** 복사 (따옴표 제외, `여기긴문자열` 부분만)  
3. **Railway** → 해당 웹 서비스 → **Variables** 탭 → **New Variable** (또는 기존 `GOOGLE_SITE_VERIFICATION` 수정)  
   - 이름: `GOOGLE_SITE_VERIFICATION`  
   - 값: **content 값만** 붙여넣기 (예: `zf9mdqNHzw4YbORB91Hq7R5y0fZoUZAEOHsZA9g1bbU`)  
   - ⚠️ **meta 태그 전체나 따옴표를 넣지 마세요.** Railway에서 따옴표가 들어가면 값이 잘려서 head에 반영되지 않을 수 있습니다.  
4. **저장** 후 **Deployments** → 최신 배포 **⋯** → **Redeploy**  
5. 재배포가 끝나면 **환경 변수 적용 여부** 확인: `https://www.soneson.kr/api/site-verification-status` 접속 → `{"set": true}` 이 나오면 정상. `false` 이면 Variables 값이 비어 있거나 잘린 것이므로 **content 값만** 다시 넣고 재배포하세요.  
6. 브라우저에서 `https://www.soneson.kr` 접속 → **페이지 소스 보기**(우클릭 → 검사 → Elements 또는 Ctrl+U) → `<head>` 안에 `google-site-verification` 메타 태그가 있는지 확인  
7. Search Console 화면으로 돌아가 **확인** 버튼 클릭  

이 프로젝트는 메인 페이지를 렌더링할 때 `GOOGLE_SITE_VERIFICATION` 환경 변수가 있으면 해당 meta 태그를 자동으로 넣습니다. **값은 content 문자열만** 넣어야 Railway에서 잘리지 않습니다.

---

**방법 2: HTML 파일 올리기**

1. Search Console에서 **HTML 파일** 방식 선택  
2. Google이 주는 **파일 이름**(예: `google1234567890abcdef.html`)을 확인하고, **파일 내용**을 그대로 복사  
3. 프로젝트 폴더의 **`static`** 디렉터리 안에 해당 파일 이름으로 저장 (예: `static/google1234567890abcdef.html`). 파일 내용은 Google이 안내한 한 줄 그대로  
4. `static` 폴더가 없다면 프로젝트 루트에 만들고, 그 안에 파일 저장  
5. GitHub에 커밋 후 push → Railway가 자동 재배포  
6. 브라우저에서 `https://www.soneson.kr/static/google1234567890abcdef.html` (본인 파일명으로) 접속 시 내용이 보이면, Search Console에서 **확인** 클릭  

※ `static`을 이미 앱에서 **StaticFiles**로 마운트했다면 위 URL로 접근 가능합니다. 마운트 경로가 다르면 해당 경로에 맞게 URL을 넣어 확인하세요.

---

**방법 3: DNS 레코드 (도메인 관리하는 곳에서 설정)**

1. Search Console에서 **DNS 레코드** 방식 선택  
2. Google이 안내하는 **TXT 레코드** 호스트 이름·값을 확인  
3. **도메인을 관리하는 곳**(Cafe24, 가비아, Cloudflare 등)에 로그인 → DNS 설정  
4. **TXT** 타입 레코드 추가 → Google이 준 **호스트**와 **값**을 그대로 입력 후 저장  
5. DNS 전파까지 **몇 분~몇 시간** 걸릴 수 있음. Search Console에서 **확인** 클릭  

Railway는 DNS를 관리하지 않으므로, **도메인만 구매·연결한 곳**(예: Cafe24 도메인)의 DNS 설정에서 추가하면 됩니다.

---

위 중 한 가지로 **확인**이 완료되면, "웹사이트가 나에게 등록되어 있지 않습니다" 문제가 해결된 상태로 브랜딩 재인증을 요청할 수 있습니다.

---

## Railway 배포 시 (www.soneson.kr 등)

1. **환경 변수는 "웹 서비스"에 넣어야 합니다**  
   - Railway 프로젝트에서 **실제 웹 앱이 돌아가는 서비스(카드)** 를 클릭  
   - **Variables** 탭으로 이동  
   - 여기에 아래 **네 개**를 **정확한 이름**으로 추가:
     - `GOOGLE_CLIENT_ID` = (Google 콘솔에서 복사한 클라이언트 ID)
     - `GOOGLE_CLIENT_SECRET` = (클라이언트 보안 비밀)
     - `SECRET_KEY` = (32자 이상 아무 문자열)
     - `OAUTH_BASE_URL` = **`https://www.soneson.kr`** (끝에 `/` 없이, 본인 도메인에 맞게 수정)  
       → 이 값을 넣으면 로그인 시 리디렉션 URI가 항상 **https**로 고정되어 `redirect_uri_mismatch` 를 방지합니다.
   - **다른 서비스나 프로젝트 전체 Variables가 아니라, 이 웹 서비스의 Variables**에 넣어야 앱이 읽습니다.

2. **저장 후 반드시 재배포**  
   - Variables 저장만 하면 기존 컨테이너에는 적용되지 않을 수 있음  
   - **Deployments** 탭 → 최신 배포 **⋯** → **Redeploy** 실행

3. **프로덕션 리디렉션 URI는 https**  
   - 배포된 사이트(예: https://www.soneson.kr)에서는 리디렉션 URI가 **https**로 사용됩니다.  
   - Google 콘솔 **승인된 리디렉션 URI**에 다음을 추가하세요 (본인 도메인에 맞게 수정):
     ```text
     https://www.soneson.kr/auth/google/callback
     ```
   - 디버그 페이지 `https://www.soneson.kr/api/youtube/debug` 에서 **redirect_uri_등록할값**을 확인해 그 값을 Google 콘솔에 그대로 등록하면 됩니다.

4. **configured: false 가 나오는 경우**  
   - `/api/youtube/debug` 에서 `"configured": false` 이면 앱이 `GOOGLE_CLIENT_ID`를 못 읽는 상태입니다.  
   - 위 1~2번을 다시 확인: **해당 웹 서비스**의 **Variables**에 변수 추가 후 **Redeploy** 했는지 확인하세요.

5. **"400 redirect_uri_mismatch" 가 나오는 경우**  
   - Railway **Variables**에 `OAUTH_BASE_URL=https://www.soneson.kr` (본인 도메인)을 넣고 **Redeploy** 한 뒤,  
     `https://www.soneson.kr/api/youtube/debug` 에서 **redirect_uri_등록할값**을 확인합니다.  
   - Google 콘솔 **승인된 리디렉션 URI**에 그 값(`https://www.soneson.kr/auth/google/callback`)을 **한 글자도 틀리지 않게** 추가하고 저장하세요.
